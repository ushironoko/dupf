# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an Image Duplicate Finder CLI tool that scans directories for duplicate images and moves them to a duplicate folder. The tool is built with TypeScript, uses Sharp for image processing, Commander.js for CLI interface, and includes comprehensive testing with Vitest.

## Usage

### Quick Start (Recommended)

For end users who just want to use the tool:

```bash
# 1. Clone or download the repository
git clone <repository-url>
cd image-dupf

# 2. Install dependencies and build standalone executable
pnpm install
pnpm build:standalone

# 3. Use the tool (no further Node.js installation needed)
./standalone/dupf /path/to/your/images --dry-run --verbose
```

The standalone executable (`./standalone/dupf`) can be copied to any machine and used without requiring Node.js installation.

### Basic Commands

```bash
# Install dependencies (for development)
pnpm install

# Build standalone executable (recommended for distribution)
pnpm build:standalone

# Run standalone version (no Node.js required on target machine)
./standalone/dupf /path/to/images

# Dry run to see what would be moved
./standalone/dupf /path/to/images --dry-run --verbose

# Custom duplicate folder name
./standalone/dupf /path/to/images --output-dir duplicates

# Help
./standalone/dupf --help
```

### Development Commands

```bash
# Build TypeScript only
pnpm build

# Development mode (using TypeScript directly)
pnpm dev /path/to/images

# Run built version (requires Node.js)
node dist/bin/dupf.js /path/to/images
```

### Testing

```bash
# Run all tests
pnpm test:run

# Run tests in watch mode
pnpm test

# Run specific test file
pnpm test tests/unit/image-comparator.test.ts

# Setup test images (required before first test run) - runs TypeScript directly
pnpm test:setup

# Run complete test workflow (faster, no build step needed)
pnpm test:full

# Code formatting and linting
pnpm lint
pnpm format
```

## Current Features

### Core Functionality

- [x] **Duplicate Detection**: Two-stage process with hash comparison and byte-level verification
- [x] **Safe File Operations**: Automatic directory creation and collision avoidance
- [x] **Multiple Image Formats**: JPG, JPEG, PNG, GIF, BMP, WebP, TIFF support
- [x] **Performance Optimization**: Image hashing cache and memory-efficient processing
- [x] **Robust Compatibility**: Sharp fallback mechanism for environments without native dependencies

### CLI Features

- [x] **Dry Run Mode**: Preview what would be moved without actual file operations
- [x] **Verbose Output**: Detailed logging for debugging and monitoring
- [x] **Custom Output Directory**: Configurable duplicate folder name
- [x] **Error Handling**: Graceful handling of missing directories and invalid files

### Code Quality & Testing

- [x] **TypeScript**: Full TypeScript implementation with strict type checking
- [x] **Unit Tests**: Comprehensive coverage for ImageComparator and FileUtils classes (42 tests)
- [x] **Integration Tests**: End-to-end CLI testing with real image files
- [x] **Test Image Generation**: Automated creation of test images using Sharp
- [x] **ESLint & Prettier**: Code formatting and linting standards
- [x] **Build System**: TypeScript compilation with declaration files
- [x] **CI/CD Ready**: All tests pass, linting and formatting enforced

## Architecture

### Project Structure

#### Source Files (TypeScript)

- `bin/dupf.ts`: Main CLI entry point using Commander.js for argument parsing
- `lib/image-comparator.ts`: Core image comparison logic using Sharp for hashing and Node.js Buffer for byte-level comparison
- `lib/file-utils.ts`: File system utilities for finding images, creating directories, and safe file operations
- `scripts/create-test-images.ts`: Test image generation script

#### Compiled Output

- `dist/`: TypeScript compilation output with JavaScript and declaration files
- `dist/bin/dupf.js`: Compiled CLI executable
- `standalone/`: Single-file executable built with @vercel/ncc
- `standalone/dupf`: Self-contained executable (no dependencies required)

#### Testing

- `tests/unit/`: Unit tests for individual classes (TypeScript)
- `tests/integration/`: End-to-end CLI tests (TypeScript)
- `tests/features/images/`: Test image files generated by Sharp

#### Configuration

- `tsconfig.json`: TypeScript compiler configuration
- `.eslintrc.cjs`: ESLint configuration for code quality
- `.prettierrc`: Prettier configuration for code formatting
- `vitest.config.js`: Vitest test runner configuration

### Duplicate Detection Process

1. **File Discovery**: Recursively find all supported image files, excluding existing duplicate folders
2. **Hash Generation**:
   - **Primary method**: Create 8x8 grayscale image hashes (MD5) using Sharp for high-quality detection
   - **Fallback method**: Use file-based MD5 hash when Sharp is not available
3. **Hash Comparison**: Group images by hash to identify potential duplicates
4. **Byte-level Verification**: Compare file contents byte-by-byte for hash matches
5. **Safe Moving**: Move duplicates to designated folder with collision avoidance

## Implementation Roadmap

### Phase 1: Core Implementation [COMPLETED]

- [x] Basic CLI interface with Commander.js
- [x] Image comparison using Sharp and Buffer
- [x] File utilities for safe operations
- [x] Comprehensive test suite with Vitest
- [x] ES Modules conversion
- [x] Error handling and validation

### Phase 1.5: Code Quality & Type Safety [COMPLETED]

- [x] **Complete ESM Migration**: Ensure all imports/exports use proper ESM syntax
- [x] **TypeScript Conversion**: Convert all JavaScript files to TypeScript
- [x] **Type Definitions**: Add comprehensive type definitions for all classes and functions
- [x] **Build System**: Set up TypeScript compilation and build pipeline
- [x] **ESLint + Prettier**: Add code formatting and linting configuration
- [x] **Type Safety in Tests**: Convert test files to TypeScript with proper type checking
- [x] **Single File Scripts**: Compile the cli tool into a single file and make it executable using vercel/ncc
- [x] **Sharp Fallback**: Add graceful fallback when Sharp is not available (uses file-based hash)

### Phase 2: Enhanced Features [TODO]

- [ ] **Progress Indicators**: Add progress bars for large directory scans
- [ ] **Configuration File**: Support for `.duplicaterc` config files
- [ ] **Multiple Output Formats**: JSON, CSV reporting of found duplicates
- [ ] **Similarity Threshold**: Allow near-duplicate detection with configurable similarity
- [ ] **Exclude Patterns**: Support for .gitignore-style exclude patterns

### Phase 3: Performance & Scalability [TODO]

- [ ] **Parallel Processing**: Multi-threaded image processing for large datasets
- [ ] **Database Backend**: SQLite for persistent hash storage and incremental scans
- [ ] **Memory Optimization**: Streaming processing for very large image collections
- [ ] **Resume Capability**: Interrupt and resume long-running operations

### Phase 4: Advanced Features [TODO]

- [ ] **Web Interface**: Optional web UI for visual duplicate review
- [ ] **Cloud Storage**: Support for cloud storage providers (S3, Google Drive)
- [ ] **Undo Operations**: Ability to reverse duplicate moves
- [ ] **Smart Recommendations**: ML-based suggestion of which duplicate to keep

### Phase 5: Distribution & Integration [TODO]

- [ ] **NPM Package**: Publish as installable npm package
- [ ] **Docker Support**: Containerized version for easy deployment
- [ ] **CI/CD Pipeline**: Automated testing and release process
- [ ] **Documentation**: Comprehensive user and developer documentation

## Development Guidelines

### Code Standards

- Use ES Modules throughout the project
- Follow functional programming patterns where possible
- Maintain high test coverage (>90%)
- Use TypeScript for type safety (completed in Phase 1.5)
- Follow ESLint and Prettier formatting standards

### Testing Strategy

- Unit tests for all utility functions and classes
- Integration tests for CLI workflows
- Use real image files in tests for accuracy
- Test error conditions and edge cases

### Performance Considerations

- Cache image hashes to avoid recomputation
- Use streaming for large file operations
- Minimize memory footprint for large image collections
- Optimize Sharp operations for batch processing

## Commands Reference

### Development Commands

- **Install dependencies**: `pnpm install`
- **Build TypeScript**: `pnpm build`
- **Build standalone**: `pnpm build:standalone`
- **Development mode**: `pnpm dev <directory> [options]`
- **Code linting**: `pnpm lint`
- **Code formatting**: `pnpm format`

### Running the Tool

- **Standalone executable**: `./standalone/dupf <directory> [options]`
- **Built CLI (requires Node.js)**: `node dist/bin/dupf.js <directory> [options]`
- **Test with dry run**: `./standalone/dupf /path/to/images --dry-run --verbose`

### Testing Commands

- **Run all tests**: `pnpm test:run`
- **Run tests in watch mode**: `pnpm test`
- **Run tests with UI**: `pnpm test:ui`
- **Setup test images**: `pnpm test:setup` (runs TypeScript directly with tsx)
- **Complete test workflow**: `pnpm test:full` (setup + run tests)

### Distribution & Deployment

For distributing the tool to end users:

```bash
# Build the standalone executable
pnpm build:standalone

# The following file can be distributed independently:
# ./standalone/dupf (~397KB, self-contained)

# Users can run it directly without any installation:
./standalone/dupf /path/to/images
```

**Distribution advantages:**

- Single file deployment (~397KB)
- No Node.js runtime required on target machines
- No dependency installation needed
- Works on any compatible system architecture

### Important Notes

- **Package manager**: This project uses pnpm, not npm
- **Standalone executable**: `./standalone/dupf` is a self-contained file with all dependencies bundled
- **No Node.js required**: The standalone version works without Node.js installation on the target machine
- **Development**: Use `pnpm dev` for TypeScript development mode
- **Distribution**: Use `pnpm build:standalone` to create the deployable executable
